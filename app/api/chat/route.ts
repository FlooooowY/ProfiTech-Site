import { NextRequest, NextResponse } from 'next/server';
import { getCollection } from '@/lib/db';
import { Product } from '@/types';

// –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenRouter API –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–æ–¥–µ–ª–∏ MiMo-V2-Flash –æ—Ç Xiaomi
// –î–ª—è —Ä–∞–±–æ—Ç—ã –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å OPENROUTER_API_KEY –≤ .env.local
// –ü–æ–ª—É—á–∏—Ç—å –∫–ª—é—á –º–æ–∂–Ω–æ –Ω–∞ https://openrouter.ai/

const OPENROUTER_API_URL = 'https://openrouter.ai/api/v1/chat/completions';
const MODEL = 'xiaomi/mimo-v2-flash'; // –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –º–æ–¥–µ–ª—å –æ—Ç Xiaomi

export async function POST(request: NextRequest) {
  try {
    const { message, messages: conversationHistory = [] } = await request.json();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ API –∫–ª—é—á–∞
    const apiKey = process.env.OPENROUTER_API_KEY;
    
    if (!apiKey) {
      console.warn('OPENROUTER_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback –ª–æ–≥–∏–∫–∞');
      // Fallback –Ω–∞ –ø—Ä–æ—Å—Ç—É—é –ª–æ–≥–∏–∫—É, –µ—Å–ª–∏ API –∫–ª—é—á –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
      return getFallbackResponse(message);
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
    const messageLower = message.toLowerCase();
    let suggestedCategory = null;
    let suggestedCategoryId = null;
    let suggestedSubcategoryId = null;
    let suggestedLink = null;
    let exampleProducts: string[] = [];

    // –ú–∞–ø–ø–∏–Ω–≥ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –ø–æ–∏—Å–∫ –ø—Ä–∏–º–µ—Ä–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤
    if (messageLower.includes('–ø–µ–∫–∞—Ä–Ω') || messageLower.includes('—Ö–ª–µ–±–æ–ø–µ–∫–∞—Ä–Ω') || messageLower.includes('—Ö–ª–µ–±')) {
      suggestedCategory = '–•–ª–µ–±–æ–ø–µ–∫–∞—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ';
      suggestedCategoryId = '1';
      suggestedSubcategoryId = '1-4';
      suggestedLink = '/catalog?categoryId=1&subcategories=1-4';
      
      // –ò—â–µ–º –ø—Ä–∏–º–µ—Ä—ã —Ç–æ–≤–∞—Ä–æ–≤
      try {
        const productsCollection = await getCollection<Product>('products');
        const products = await productsCollection
          .find({ 
            categoryId: '1',
            subcategoryId: { $regex: /hlebopekarnoe|—Ö–ª–µ–±–æ–ø–µ–∫–∞—Ä–Ω/i }
          })
          .limit(5)
          .toArray();
        exampleProducts = products.map(p => p.name).filter(Boolean);
      } catch (e) {
        console.error('Error fetching products:', e);
      }
    } else if (messageLower.includes('–∫–æ–Ω–¥–∏—Ç–µ—Ä') || messageLower.includes('—Ç–æ—Ä—Ç')) {
      suggestedCategory = '–ö–æ–Ω–¥–∏—Ç–µ—Ä—Å–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ';
      suggestedCategoryId = '1';
      suggestedSubcategoryId = '1-5';
      suggestedLink = '/catalog?categoryId=1&subcategories=1-5';
      
      try {
        const productsCollection = await getCollection<Product>('products');
        const products = await productsCollection
          .find({ 
            categoryId: '1',
            subcategoryId: { $regex: /konditerskoe|–∫–æ–Ω–¥–∏—Ç–µ—Ä—Å–∫/i }
          })
          .limit(5)
          .toArray();
        exampleProducts = products.map(p => p.name).filter(Boolean);
      } catch (e) {
        console.error('Error fetching products:', e);
      }
    } else if (messageLower.includes('–∫–æ—Ñ–µ') || messageLower.includes('–∫–æ—Ñ–µ–º–∞—à–∏–Ω') || messageLower.includes('–∫–æ—Ñ–µ–≤–∞—Ä–∫')) {
      suggestedCategory = '–ö–æ—Ñ–µ–≤–∞—Ä–∫–∏ –∏ –∫–æ—Ñ–µ–º–∞—à–∏–Ω—ã';
      suggestedCategoryId = '2';
      suggestedLink = '/catalog?categoryId=2';
      
      try {
        const productsCollection = await getCollection<Product>('products');
        const products = await productsCollection
          .find({ categoryId: '2' })
          .limit(5)
          .toArray();
        exampleProducts = products.map(p => p.name).filter(Boolean);
      } catch (e) {
        console.error('Error fetching products:', e);
      }
    } else if (messageLower.includes('—Ö–æ–ª–æ–¥–∏–ª—å–Ω') || messageLower.includes('–º–æ—Ä–æ–∑–∏–ª–∫')) {
      suggestedCategory = '–•–æ–ª–æ–¥–∏–ª—å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ';
      suggestedCategoryId = '1';
      suggestedSubcategoryId = '1-2';
      suggestedLink = '/catalog?categoryId=1&subcategories=1-2';
    } else if (messageLower.includes('–±–∞—Ä') || messageLower.includes('–∫–æ–∫—Ç–µ–π–ª')) {
      suggestedCategory = '–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è –±–∞—Ä–æ–≤';
      suggestedCategoryId = '1';
      suggestedSubcategoryId = '1-6';
      suggestedLink = '/catalog?categoryId=1&subcategories=1-6';
    } else if (messageLower.includes('–º–µ–±–µ–ª—å')) {
      suggestedCategory = '–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–∞—è –º–µ–±–µ–ª—å';
      suggestedCategoryId = '3';
      suggestedLink = '/catalog?categoryId=3';
    } else if (messageLower.includes('–∫–ª–∏–º–∞—Ç') || messageLower.includes('–∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä') || messageLower.includes('–≤–µ–Ω—Ç–∏–ª—è—Ü')) {
      suggestedCategory = '–ö–ª–∏–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç–µ—Ö–Ω–∏–∫–∞';
      suggestedCategoryId = '4';
      suggestedLink = '/catalog?categoryId=4';
    }

    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
    let systemPrompt = `–¢—ã - –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –∑–Ω–∞—é—â–∏–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–∞ ProfiTech, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞–º –≤—ã–±—Ä–∞—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ.

–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤:
1. –ü—Ä–æ—Ñ–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ:
   - –•–ª–µ–±–æ–ø–µ–∫–∞—Ä–Ω–æ–µ: –ø–µ—á–∏ –¥–ª—è —Ö–ª–µ–±–∞ (—Ä–æ—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ, –∫–æ–Ω–≤–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ, –∫–∞–º–µ–Ω–Ω—ã–µ), —Ç–µ—Å—Ç–æ–º–µ—Å—ã, —Ä–∞—Å—Å—Ç–æ–µ—á–Ω—ã–µ —à–∫–∞—Ñ—ã, —Ñ–æ—Ä–º—ã –¥–ª—è –≤—ã–ø–µ—á–∫–∏
   - –ö–æ–Ω–¥–∏—Ç–µ—Ä—Å–∫–æ–µ: –∫–æ–Ω–¥–∏—Ç–µ—Ä—Å–∫–∏–µ –ø–µ—á–∏, –º–∏–∫—Å–µ—Ä—ã, —Ç–µ—Å—Ç–æ–º–µ—Å—ã, –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —à–æ–∫–æ–ª–∞–¥–æ–º
   - –•–æ–ª–æ–¥–∏–ª—å–Ω–æ–µ: —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∏, –º–æ—Ä–æ–∑–∏–ª—å–Ω–∏–∫–∏, –≤–∏—Ç—Ä–∏–Ω—ã, —à–æ–∫–æ–≤—ã–µ –º–æ—Ä–æ–∑–∏–ª—å–Ω–∏–∫–∏
   - –¢–µ–ø–ª–æ–≤–æ–µ: –ø–µ—á–∏, –ø–ª–∏—Ç—ã, –≥—Ä–∏–ª–∏, —Ñ—Ä–∏—Ç—é—Ä–Ω–∏—Ü—ã
   - –î–ª—è –±–∞—Ä–æ–≤: –ª—å–¥–æ–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã, –±–ª–µ–Ω–¥–µ—Ä—ã, —à–µ–π–∫–µ—Ä—ã, –±–∞—Ä–Ω—ã–µ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∏
   - –ò –¥—Ä—É–≥–∏–µ —Ç–∏–ø—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è

2. –ö–æ—Ñ–µ–≤–∞—Ä–∫–∏ –∏ –∫–æ—Ñ–µ–º–∞—à–∏–Ω—ã: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ—Ñ–µ–º–∞—à–∏–Ω—ã, —ç—Å–ø—Ä–µ—Å—Å–æ-–º–∞—à–∏–Ω—ã, –∫–æ—Ñ–µ–º–æ–ª–∫–∏, –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã
3. –ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–∞—è –º–µ–±–µ–ª—å: –¥–ª—è –∫—É—Ö–Ω–∏, –∑–∞–ª–∞, –±–∞—Ä–∞, –æ—Ñ–∏—Å–∞
4. –ö–ª–∏–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç–µ—Ö–Ω–∏–∫–∞: –≤–µ–Ω—Ç–∏–ª—è—Ü–∏—è, –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä—ã, –æ–±–æ–≥—Ä–µ–≤–∞—Ç–µ–ª–∏
5. –¢–µ–ª–µ–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–æ–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
6. –¢–æ—á–∫–∏ –ø—Ä–æ–¥–∞–∂ (POS-—Å–∏—Å—Ç–µ–º—ã)
7. –ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞

–¢–≤–æ—è –∑–∞–¥–∞—á–∞:
- –û—Ç–≤–µ—á–∞–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –∫–∞–∫ –∂–∏–≤–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç
- –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º: —Å—Ä–∞–∑—É –Ω–∞–∑—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–∏–ø—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ –ø–µ–∫–∞—Ä–Ω—é - —Ä–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –ø–µ—á–∏, —Ç–µ—Å—Ç–æ–º–µ—Å—ã, —Ä–∞—Å—Å—Ç–æ–µ—á–Ω—ã–µ —à–∫–∞—Ñ—ã
- –ü—Ä–µ–¥–ª–∞–≥–∞–π –ø–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–æ–≤–∞—Ä–æ–≤
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã —Ç–∏–ø–∞ "—Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ" –∏–ª–∏ "—á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç"
- –ù–ï –ø–æ–≤—Ç–æ—Ä—è–π –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –æ—Ç–≤–µ—Ç –Ω–∞ —Ä–∞–∑–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã

–í–∞–∂–Ω–æ:
- –¶–µ–Ω—ã —É—Ç–æ—á–Ω—è—é—Ç—Å—è —É –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ —á–µ—Ä–µ–∑ WhatsApp
- –í—Å–µ–≥–¥–∞ –¥–∞–≤–∞–π —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥ –≤ –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞`;

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ –∑–∞–ø—Ä–æ—Å–µ –∏ –ø—Ä–∏–º–µ—Ä–∞—Ö —Ç–æ–≤–∞—Ä–æ–≤
    if (suggestedCategory) {
      systemPrompt += `\n\n–í–ê–ñ–ù–û: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ "${suggestedCategory}".`;
      
      if (exampleProducts.length > 0) {
        systemPrompt += `\n\n–í –Ω–∞—à–µ–º –∫–∞—Ç–∞–ª–æ–≥–µ –µ—Å—Ç—å —Ç–∞–∫–∏–µ —Ç–æ–≤–∞—Ä—ã:\n${exampleProducts.slice(0, 3).map(p => `- ${p}`).join('\n')}`;
        systemPrompt += `\n\n–£–ø–æ–º—è–Ω–∏ —ç—Ç–∏ –ø—Ä–∏–º–µ—Ä—ã –≤ –æ—Ç–≤–µ—Ç–µ, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ —É –Ω–∞—Å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –µ—Å—Ç—å —Ç–æ–≤–∞—Ä—ã.`;
      }
      
      systemPrompt += `\n\n–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥: ${suggestedLink}`;
      systemPrompt += `\n\n–û—Ç–≤–µ—á–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –∏ –ø–æ –¥–µ–ª—É. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã.`;
    }

    // –§–æ—Ä–º–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    const messages = [
      { role: 'system', content: systemPrompt },
      ...conversationHistory.slice(-10), // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
      { role: 'user', content: message }
    ];

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ OpenRouter API
    const response = await fetch(OPENROUTER_API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`,
        'HTTP-Referer': process.env.NEXT_PUBLIC_SITE_URL || 'https://profitech.store',
        'X-Title': 'ProfiTech AI Assistant',
      },
      body: JSON.stringify({
        model: MODEL,
        messages: messages,
        temperature: 0.7,
        max_tokens: 500,
      }),
    });

    if (!response.ok) {
      const errorData = await response.text();
      console.error('OpenRouter API Error:', response.status, errorData);
      
      // Fallback –Ω–∞ –ø—Ä–æ—Å—Ç—É—é –ª–æ–≥–∏–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ API
      return getFallbackResponse(message);
    }

    const data = await response.json();
    
    if (data.choices && data.choices[0] && data.choices[0].message) {
      let aiResponse = data.choices[0].message.content;
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥, –µ—Å–ª–∏ –±—ã–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è
      if (suggestedCategory && suggestedLink && !aiResponse.includes('/catalog')) {
        aiResponse += `\n\nüì¶ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–≤–∞—Ä—ã –≤ –∫–∞—Ç–∞–ª–æ–≥–µ: ${suggestedLink}`;
      }
      
      return NextResponse.json({ 
        success: true, 
        message: aiResponse,
        suggestedLink: suggestedLink || null
      });
    } else {
      console.error('Unexpected response format:', data);
      return getFallbackResponse(message);
    }

  } catch (error) {
    console.error('AI Chat Error:', error);
    // Fallback –Ω–∞ –ø—Ä–æ—Å—Ç—É—é –ª–æ–≥–∏–∫—É –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
    const { message } = await request.json();
    return getFallbackResponse(message);
  }
}

// Fallback —Ñ—É–Ω–∫—Ü–∏—è —Å –ø—Ä–æ—Å—Ç–æ–π –ª–æ–≥–∏–∫–æ–π (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
function getFallbackResponse(message: string) {
  const messageLower = message.toLowerCase();
  let response = '';
  
  if (messageLower.includes('–∫–æ—Ñ–µ') || messageLower.includes('–∫–æ—Ñ–µ–º–∞—à–∏–Ω')) {
    response = '–û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä! –£ –Ω–∞—Å —à–∏—Ä–æ–∫–∏–π –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç –∫–æ—Ñ–µ–π–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è. –†–µ–∫–æ–º–µ–Ω–¥—É—é –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ä–∞–∑–¥–µ–ª "–ö–æ—Ñ–µ–≤–∞—Ä–∫–∏ –∏ –∫–æ—Ñ–µ–º–∞—à–∏–Ω—ã". –¢–∞–º –≤—ã –Ω–∞–π–¥–µ—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫–æ—Ñ–µ–º–∞—à–∏–Ω—ã, –∫–æ—Ñ–µ–º–æ–ª–∫–∏ –∏ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã. –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ—Ñ–µ–º–∞—à–∏–Ω—ã, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —ç—Å–ø—Ä–µ—Å—Å–æ-–º–∞—à–∏–Ω—ã –∏–ª–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–æ—Ñ–µ–º–æ–ª–∫–∏?';
  } else if (messageLower.includes('—Ö–æ–ª–æ–¥–∏–ª—å–Ω')) {
    response = '–î–ª—è —Ö–æ–ª–æ–¥–∏–ª—å–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —É –Ω–∞—Å –µ—Å—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∞–∑–¥–µ–ª –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–ü—Ä–æ—Ñ–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ". –ú—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–µ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –æ–±—ä–µ–º–æ–≤ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ –≤–∞—à–∏—Ö –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è—Ö: –∫–∞–∫–æ–π –æ–±—ä–µ–º –Ω—É–∂–µ–Ω, –¥–ª—è –∫–∞–∫–∏—Ö —Ü–µ–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ?';
  } else if (messageLower.includes('–±–∞—Ä')) {
    response = '–î–ª—è –æ—Å–Ω–∞—â–µ–Ω–∏—è –±–∞—Ä–∞ —É –Ω–∞—Å –µ—Å—Ç—å —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–¥–µ–ª "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è –±–∞—Ä–æ–≤" –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–æ—Ñ–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è. –¢–∞–º –≤—ã –Ω–∞–π–¥–µ—Ç–µ –ª—å–¥–æ–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã, –±–ª–µ–Ω–¥–µ—Ä—ã, –±–∞—Ä–Ω—ã–µ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∏ –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ. –¢–∞–∫–∂–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ—Ñ–µ–π–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ. –ö–∞–∫–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –ø–æ–∑–∏—Ü–∏–∏ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç?';
  } else if (messageLower.includes('–ø–µ–∫–∞—Ä–Ω') || messageLower.includes('—Ö–ª–µ–±–æ–ø–µ–∫–∞—Ä–Ω') || messageLower.includes('—Ö–ª–µ–±')) {
    // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø—Ä–∏–º–µ—Ä—ã —Ç–æ–≤–∞—Ä–æ–≤
    let productExamples = '';
    try {
      const productsCollection = await getCollection<Product>('products');
      const products = await productsCollection
        .find({ 
          categoryId: '1',
          subcategoryId: { $regex: /hlebopekarnoe|—Ö–ª–µ–±–æ–ø–µ–∫–∞—Ä–Ω/i }
        })
        .limit(3)
        .toArray();
      
      if (products.length > 0) {
        productExamples = '\n\n–ù–∞–ø—Ä–∏–º–µ—Ä, —É –Ω–∞—Å –µ—Å—Ç—å:\n' + products.map(p => `‚Ä¢ ${p.name}`).join('\n');
      }
    } catch (e) {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Ç–æ–≤–∞—Ä–æ–≤
    }
    
    response = `–î–ª—è –ø–µ–∫–∞—Ä–Ω–∏ —É –Ω–∞—Å –±–æ–ª—å—à–æ–π –≤—ã–±–æ—Ä —Ö–ª–µ–±–æ–ø–µ–∫–∞—Ä–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è!${productExamples}\n\n–í –∫–∞—Ç–∞–ª–æ–≥–µ –≤—ã –Ω–∞–π–¥–µ—Ç–µ:\n‚Ä¢ –ü–µ—á–∏ –¥–ª—è —Ö–ª–µ–±–∞ (—Ä–æ—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ, –∫–æ–Ω–≤–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ, –∫–∞–º–µ–Ω–Ω—ã–µ)\n‚Ä¢ –¢–µ—Å—Ç–æ–º–µ—Å—ã –∏ –º–∏–∫—Å–µ—Ä—ã –¥–ª—è —Ç–µ—Å—Ç–∞\n‚Ä¢ –†–∞—Å—Å—Ç–æ–µ—á–Ω—ã–µ —à–∫–∞—Ñ—ã\n‚Ä¢ –§–æ—Ä–º—ã –¥–ª—è –≤—ã–ø–µ—á–∫–∏\n‚Ä¢ –î–µ–ª–∏—Ç–µ–ª–∏ –∏ –æ–∫—Ä—É–≥–ª–∏—Ç–µ–ª–∏ —Ç–µ—Å—Ç–∞\n\n–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–∞—Ç–∞–ª–æ–≥–µ: /catalog?categoryId=1&subcategories=1-4`;
  } else if (messageLower.includes('–∫–æ–Ω–¥–∏—Ç–µ—Ä') || messageLower.includes('—Ç–æ—Ä—Ç')) {
    response = '–î–ª—è –∫–æ–Ω–¥–∏—Ç–µ—Ä—Å–∫–æ–π —É –Ω–∞—Å –µ—Å—Ç—å —Ä–∞–∑–¥–µ–ª "–ö–æ–Ω–¥–∏—Ç–µ—Ä—Å–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ" –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–ü—Ä–æ—Ñ–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ". –¢–∞–º –≤—ã –Ω–∞–π–¥–µ—Ç–µ:\n\n‚Ä¢ –ö–æ–Ω–¥–∏—Ç–µ—Ä—Å–∫–∏–µ –ø–µ—á–∏\n‚Ä¢ –ú–∏–∫—Å–µ—Ä—ã –∏ —Ç–µ—Å—Ç–æ–º–µ—Å—ã\n‚Ä¢ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —à–æ–∫–æ–ª–∞–¥–æ–º\n‚Ä¢ –§–æ—Ä–º—ã –¥–ª—è –≤—ã–ø–µ—á–∫–∏\n‚Ä¢ –ò –¥—Ä—É–≥–æ–µ –∫–æ–Ω–¥–∏—Ç–µ—Ä—Å–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ\n\n–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –∫–∞—Ç–∞–ª–æ–≥: /catalog?categoryId=1&subcategories=1-5';
  } else if (messageLower.includes('—Ü–µ–Ω') || messageLower.includes('—Å—Ç–æ–∏–º–æ—Å—Ç') || messageLower.includes('–ø—Ä–∞–π—Å')) {
    response = '–¶–µ–Ω—ã –Ω–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —É—Ç–æ—á–Ω—è–π—Ç–µ —É –Ω–∞—à–∏—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤. –û–Ω–∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã –∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –º–Ω–æ–≥–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤. –í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω—É –∏ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–ø—Ä–æ—Å - –º—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–º –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.';
  } else if (messageLower.includes('–¥–æ—Å—Ç–∞–≤–∫')) {
    response = '–ú—ã –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ–º –¥–æ—Å—Ç–∞–≤–∫—É –ø–æ –≤—Å–µ–π –†–æ—Å—Å–∏–∏. –°—Ä–æ–∫–∏ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–≥–∏–æ–Ω–∞ –∏ –æ–±—ä–µ–º–∞ –∑–∞–∫–∞–∑–∞. –î–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞—à–∏–º–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º–∏ —á–µ—Ä–µ–∑ WhatsApp.';
  } else if (messageLower.includes('–≥–∞—Ä–∞–Ω—Ç')) {
    response = '–ù–∞ –≤—Å–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –≥–∞—Ä–∞–Ω—Ç–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è. –°—Ä–æ–∫ –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è. –¢–∞–∫–∂–µ –º—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å–µ—Ä–≤–∏—Å–Ω–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ —É—Ç–æ—á–Ω—è–π—Ç–µ —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞.';
  } else {
    response = '–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å! –Ø –º–æ–≥—É –ø–æ–º–æ—á—å –≤–∞–º:\n\n‚Ä¢ –ü–æ–¥–æ–±—Ä–∞—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –ø–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º\n‚Ä¢ –ù–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä—ã –≤ –∫–∞—Ç–∞–ª–æ–≥–µ\n‚Ä¢ –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö\n‚Ä¢ –ü–æ–º–æ—á—å —Å –≤—ã–±–æ—Ä–æ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è\n\n–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?';
  }

  return NextResponse.json({ 
    success: true, 
    message: response 
  });
}

/* 
–ü–†–ò–ú–ï–† –ò–ù–¢–ï–ì–†–ê–¶–ò–ò –° OPENAI (—Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ API –∫–ª—é—á–∞):

import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

export async function POST(request: NextRequest) {
  try {
    const { message, products } = await request.json();

    const systemPrompt = `–¢—ã - AI –ø–æ–º–æ—â–Ω–∏–∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–∞ ProfiTech, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–µ–≥–æ—Å—è –Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏.
    
–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤:
1. –ü—Ä–æ—Ñ–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ (—Ç–µ–ø–ª–æ–≤–æ–µ, —Ö–æ–ª–æ–¥–∏–ª—å–Ω–æ–µ, —ç–ª–µ–∫—Ç—Ä–æ–º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–æ–µ –∏ –¥—Ä.)
2. –ö–æ—Ñ–µ–≤–∞—Ä–∫–∏ –∏ –∫–æ—Ñ–µ–º–∞—à–∏–Ω—ã
3. –ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–∞—è –º–µ–±–µ–ª—å
4. –ö–ª–∏–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç–µ—Ö–Ω–∏–∫–∞
5. –¢–µ–ª–µ–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–æ–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
6. –¢–æ—á–∫–∏ –ø—Ä–æ–¥–∞–∂

–¢–≤–æ—è –∑–∞–¥–∞—á–∞:
- –ü–æ–º–æ–≥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞–º —Å –≤—ã–±–æ—Ä–æ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
- –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞—Ö
- –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä—ã
- –ë—ã—Ç—å –≤–µ–∂–ª–∏–≤—ã–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º

–í–∞–∂–Ω–æ: —Ü–µ–Ω—ã –Ω–µ —É–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –Ω–∞ —Å–∞–π—Ç–µ, –∏—Ö –Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω—è—Ç—å —É –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤.`;

    const completion = await openai.chat.completions.create({
      model: "gpt-4",
      messages: [
        { role: "system", content: systemPrompt },
        { role: "user", content: message }
      ],
      temperature: 0.7,
      max_tokens: 500,
    });

    const response = completion.choices[0].message.content;

    return NextResponse.json({ 
      success: true, 
      message: response 
    });

  } catch (error) {
    console.error('AI Chat Error:', error);
    return NextResponse.json(
      { success: false, error: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞' },
      { status: 500 }
    );
  }
}
*/

