#!/bin/bash

# ะัะบัััะธะต ะฟะพััะพะฒ 80 ะธ 443 ะฒ UFW ะดะปั ะฒะตะฑ-ัะตัะฒะตัะฐ
# ะัะฟะพะปัะทะพะฒะฐะฝะธะต: ./fix-firewall-ports.sh

set -e

# ะฆะฒะตัะฐ
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "๐ฅ ะะฐัััะพะนะบะฐ ัะฐะนัะฒะพะปะฐ (UFW) ะดะปั ะฒะตะฑ-ัะตัะฒะตัะฐ..."
echo ""

# 1. ะัะพะฒะตัะบะฐ ััะฐัััะฐ UFW
echo "1๏ธโฃ ะัะพะฒะตัะบะฐ ััะฐัััะฐ UFW..."
UFW_STATUS=$(sudo ufw status 2>/dev/null | head -1 || echo "inactive")

if echo "$UFW_STATUS" | grep -q "inactive"; then
    echo "   โน๏ธ  UFW ะฝะตะฐะบัะธะฒะตะฝ"
    read -p "   ะะบัะธะฒะธัะพะฒะฐัั UFW? (y/n): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "   ๐ ะะบัะธะฒะฐัะธั UFW..."
        sudo ufw --force enable
        echo "   โ UFW ะฐะบัะธะฒะธัะพะฒะฐะฝ"
    else
        echo "   โน๏ธ  UFW ะพััะฐะตััั ะฝะตะฐะบัะธะฒะฝัะผ"
        exit 0
    fi
else
    echo "   โ UFW ะฐะบัะธะฒะตะฝ"
fi
echo ""

# 2. ะัะพะฒะตัะบะฐ ัััะตััะฒัััะธั ะฟัะฐะฒะธะป
echo "2๏ธโฃ ะัะพะฒะตัะบะฐ ัััะตััะฒัััะธั ะฟัะฐะฒะธะป..."
echo "   ะขะตะบััะธะต ะฟัะฐะฒะธะปะฐ UFW:"
sudo ufw status numbered | grep -E "(80|443|HTTP|HTTPS)" || echo "   ะัะฐะฒะธะปะฐ ะดะปั ะฟะพััะพะฒ 80/443 ะฝะต ะฝะฐะนะดะตะฝั"
echo ""

# 3. ะัะบัััะธะต ะฟะพััะพะฒ
echo "3๏ธโฃ ะัะบัััะธะต ะฟะพััะพะฒ ะดะปั ะฒะตะฑ-ัะตัะฒะตัะฐ..."

# ะะพัั 80 (HTTP)
if sudo ufw status | grep -q "80/tcp"; then
    echo "   โ ะะพัั 80 ัะถะต ะพัะบััั"
else
    echo "   ๐ ะัะบัััะธะต ะฟะพััะฐ 80 (HTTP)..."
    sudo ufw allow 80/tcp comment 'HTTP'
    echo "   โ ะะพัั 80 ะพัะบััั"
fi

# ะะพัั 443 (HTTPS)
if sudo ufw status | grep -q "443/tcp"; then
    echo "   โ ะะพัั 443 ัะถะต ะพัะบััั"
else
    echo "   ๐ ะัะบัััะธะต ะฟะพััะฐ 443 (HTTPS)..."
    sudo ufw allow 443/tcp comment 'HTTPS'
    echo "   โ ะะพัั 443 ะพัะบััั"
fi

# ะะพัั 22 (SSH) - ะฝะฐ ะฒััะบะธะน ัะปััะฐะน, ััะพะฑั ะฝะต ะฟะพัะตัััั ะดะพัััะฟ
if sudo ufw status | grep -q "22/tcp"; then
    echo "   โ ะะพัั 22 (SSH) ัะถะต ะพัะบััั"
else
    echo "   ๐ ะัะบัััะธะต ะฟะพััะฐ 22 (SSH)..."
    sudo ufw allow 22/tcp comment 'SSH'
    echo "   โ ะะพัั 22 ะพัะบััั"
fi
echo ""

# 4. ะะพะบะฐะทัะฒะฐะตะผ ะธัะพะณะพะฒัะน ััะฐััั
echo "4๏ธโฃ ะัะพะณะพะฒัะน ััะฐััั UFW..."
sudo ufw status numbered
echo ""

# 5. ะัะพะฒะตัะบะฐ ะดะพัััะฟะฝะพััะธ ะฟะพััะพะฒ
echo "5๏ธโฃ ะัะพะฒะตัะบะฐ ะดะพัััะฟะฝะพััะธ ะฟะพััะพะฒ..."
sleep 2

# ะัะพะฒะตััะตะผ, ััะพ ะฟะพััั ัะปััะฐัััั
if command -v netstat &> /dev/null; then
    PORT_80=$(sudo netstat -tlnp 2>/dev/null | grep ":80 " || echo "")
    PORT_443=$(sudo netstat -tlnp 2>/dev/null | grep ":443 " || echo "")
elif command -v ss &> /dev/null; then
    PORT_80=$(sudo ss -tlnp 2>/dev/null | grep ":80 " || echo "")
    PORT_443=$(sudo ss -tlnp 2>/dev/null | grep ":443 " || echo "")
fi

if [ -n "$PORT_80" ]; then
    echo "   โ ะะพัั 80 ัะปััะฐะตััั"
else
    echo "   โ๏ธ  ะะพัั 80 ะฝะต ัะปััะฐะตััั (ะฟัะพะฒะตัััะต Nginx)"
fi

if [ -n "$PORT_443" ]; then
    echo "   โ ะะพัั 443 ัะปััะฐะตััั"
else
    echo "   โ๏ธ  ะะพัั 443 ะฝะต ัะปััะฐะตััั (ะฟัะพะฒะตัััะต Nginx)"
fi
echo ""

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "โ ะคะฐะนัะฒะพะป ะฝะฐัััะพะตะฝ!"
echo ""
echo "๐ ะงัะพ ะดะฐะปััะต:"
echo ""
echo "   1. DNS ะทะฐะฟะธัะธ ะตัะต ัะฐัะฟัะพัััะฐะฝััััั (1-24 ัะฐัะฐ)"
echo "      - Google DNS ัะถะต ะฒะธะดะธั ะดะพะผะตะฝ โ"
echo "      - Cloudflare ะธ Quad9 ะตัะต ะฝะต ะฒะธะดัั โณ"
echo ""
echo "   2. ะะพะฟัะพัะธัะต ะดััะณะธั:"
echo "      - ะัะธััะธัั DNS ะบัั (ipconfig /flushdns ะฝะฐ Windows)"
echo "      - ะะพะดะพะถะดะฐัั 1-2 ัะฐัะฐ"
echo "      - ะะพะฟัะพะฑะพะฒะฐัั ัะตัะตะท ะผะพะฑะธะปัะฝัะน ะธะฝัะตัะฝะตั"
echo ""
echo "   3. ะัะพะฒะตัััะต ะดะพัััะฟะฝะพััั ัะตัะตะท ะพะฝะปะฐะนะฝ ัะตัะฒะธัั:"
echo "      https://dnschecker.org/#A/profitech.store"
echo "      https://www.isitdownrightnow.com/profitech.store.html"
echo ""

