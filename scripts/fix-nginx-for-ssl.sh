#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx Ð¿ÐµÑ€ÐµÐ´ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸ÐµÐ¼ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: ./scripts/fix-nginx-for-ssl.sh

set -e

NGINX_CONF="/etc/nginx/sites-available/profitech"

echo "ðŸ”§ Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð»Ð¸ Ñ„Ð°Ð¹Ð»
if [ ! -f "$NGINX_CONF" ]; then
    echo "âŒ Ð¤Ð°Ð¹Ð» $NGINX_CONF Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
    exit 1
fi

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½ÑƒÑŽ ÐºÐ¾Ð¿Ð¸ÑŽ
echo "ðŸ’¾ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ð¹ ÐºÐ¾Ð¿Ð¸Ð¸..."
sudo cp "$NGINX_CONF" "${NGINX_CONF}.backup.$(date +%Y%m%d_%H%M%S)"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ñ€ÐµÐ´Ð¸Ñ€ÐµÐºÑ‚ Ð½Ð° HTTPS
if grep -q "return 301 https" "$NGINX_CONF"; then
    echo "âš ï¸  ÐÐ°Ð¹Ð´ÐµÐ½ Ñ€ÐµÐ´Ð¸Ñ€ÐµÐºÑ‚ Ð½Ð° HTTPS - Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°..."
    
    # ÐšÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ´Ð¸Ñ€ÐµÐºÑ‚
    sudo sed -i 's/^[[:space:]]*return 301 https/# &/' "$NGINX_CONF"
    echo "âœ… Ð ÐµÐ´Ð¸Ñ€ÐµÐºÑ‚ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½"
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð±Ð»Ð¾Ðº ACME challenge ÐµÑÑ‚ÑŒ Ð¸ Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÑÑ ÐŸÐ•Ð Ð•Ð” location /
if ! grep -q "\.well-known/acme-challenge" "$NGINX_CONF"; then
    echo "âš ï¸  Ð‘Ð»Ð¾Ðº ACME challenge Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ - Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼..."
    ./scripts/add-acme-to-nginx.sh
fi

# Ð£Ð±ÐµÐ¶Ð´Ð°ÐµÐ¼ÑÑ, Ñ‡Ñ‚Ð¾ Ð±Ð»Ð¾Ðº Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÑÑ ÐŸÐ•Ð Ð•Ð” location /
ACME_LINE=$(grep -n "\.well-known/acme-challenge" "$NGINX_CONF" | head -1 | cut -d: -f1)
LOCATION_LINE=$(grep -n "^\s*location\s\+/\s\+{" "$NGINX_CONF" | head -1 | cut -d: -f1)

if [ -n "$ACME_LINE" ] && [ -n "$LOCATION_LINE" ] && [ "$ACME_LINE" -gt "$LOCATION_LINE" ]; then
    echo "âš ï¸  Ð‘Ð»Ð¾Ðº ACME challenge Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÑÑ ÐŸÐžÐ¡Ð›Ð• location / - ÑÑ‚Ð¾ Ð½ÐµÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾!"
    echo "   ÐŸÐµÑ€ÐµÐ¼ÐµÑ‰Ð°ÐµÐ¼ Ð±Ð»Ð¾Ðº..."
    # Ð­Ñ‚Ð¾ ÑÐ»Ð¾Ð¶Ð½Ð°Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ñ, Ð»ÑƒÑ‡ÑˆÐµ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
    echo "   âŒ Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ñ€ÑƒÑ‡Ð½Ð¾Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ"
    echo "   Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ Ð±Ð»Ð¾Ðº Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÑÑ ÐŸÐ•Ð Ð•Ð” location /"
else
    echo "âœ… Ð‘Ð»Ð¾Ðº ACME challenge Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÑÑ Ð² Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¼ Ð¼ÐµÑÑ‚Ðµ"
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ
echo ""
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸ÑÐ° Nginx..."
if sudo nginx -t; then
    echo "âœ… Ð¡Ð¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚ÐµÐ½"
    
    # ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Nginx
    echo ""
    echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Nginx..."
    sudo systemctl reload nginx
    echo "âœ… Nginx Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½"
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ
    echo ""
    echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸..."
    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://profitech.store || echo "000")
    if [ "$HTTP_CODE" = "200" ]; then
        echo "âœ… Ð”Ð¾Ð¼ÐµÐ½ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ (HTTP 200)"
    elif [ "$HTTP_CODE" = "307" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
        echo "âš ï¸  Ð”Ð¾Ð¼ÐµÐ½ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ñ€ÐµÐ´Ð¸Ñ€ÐµÐºÑ‚ (HTTP $HTTP_CODE)"
        echo "   Ð­Ñ‚Ð¾ Ð¼Ð¾Ð¶ÐµÑ‚ Ð¼ÐµÑˆÐ°Ñ‚ÑŒ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸ÑŽ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°"
        echo "   ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ"
    else
        echo "âš ï¸  HTTP ÐºÐ¾Ð´: $HTTP_CODE"
    fi
    
    echo ""
    echo "âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð°"
    echo ""
    echo "ðŸ“‹ Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚:"
    echo "   sudo certbot --nginx -d profitech.store -d www.profitech.store"
    echo ""
    echo "âš ï¸  ÐŸÐ¾ÑÐ»Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð° Ñ€Ð°ÑÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ñ€ÐµÐ´Ð¸Ñ€ÐµÐºÑ‚ Ð½Ð° HTTPS:"
    echo "   sudo nano $NGINX_CONF"
    echo "   ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ Ð¸ Ñ€Ð°ÑÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ: # return 301 https"
else
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð² ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx!"
    echo "   Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½ÑƒÑŽ ÐºÐ¾Ð¿Ð¸ÑŽ..."
    sudo cp "${NGINX_CONF}.backup."* "$NGINX_CONF" 2>/dev/null || true
    exit 1
fi

