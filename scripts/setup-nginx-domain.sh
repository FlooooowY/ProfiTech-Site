#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Nginx –¥–ª—è –¥–æ–º–µ–Ω–∞
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./setup-nginx-domain.sh profitech.store

set -e

# –¶–≤–µ—Ç–∞
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
if [ -z "$1" ]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <domain>"
    echo "–ü—Ä–∏–º–µ—Ä: $0 profitech.store"
    exit 1
fi

DOMAIN=$1
WWW_DOMAIN="www.$DOMAIN"
PROJECT_DIR="/home/profitech/ProfiTech-Site"
NGINX_CONFIG="/etc/nginx/sites-available/$DOMAIN"

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx –¥–ª—è –¥–æ–º–µ–Ω–∞ $DOMAIN..."
echo ""

# 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤
echo "1Ô∏è‚É£ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤..."
sudo apt update -qq
echo "   ‚úÖ –ü–∞–∫–µ—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã"
echo ""

# 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Nginx (–µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
echo "2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ Nginx..."
if ! command -v nginx &> /dev/null; then
    echo "   üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Nginx..."
    sudo apt install nginx -y
    echo "   ‚úÖ Nginx —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
else
    echo "   ‚úÖ Nginx —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi
echo ""

# 3. –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
echo "3Ô∏è‚É£ –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx..."
sudo tee "$NGINX_CONFIG" > /dev/null <<EOF
server {
    listen 80;
    server_name $DOMAIN $WWW_DOMAIN;
    
    # –í–ê–ñ–ù–û: –ë–ª–æ–∫ –¥–ª—è Let's Encrypt ACME challenge (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–ï–†–ï–î location /)
    location /.well-known/acme-challenge/ {
        root /var/www/html;
        try_files \$uri =404;
    }
    
    # –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ Next.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
        
        # –¢–∞–π–º–∞—É—Ç—ã –¥–ª—è –¥–æ–ª–≥–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ Next.js
    location /_next/static {
        proxy_pass http://localhost:3000;
        proxy_cache_valid 200 60m;
        add_header Cache-Control "public, immutable";
    }
    
    # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    location /uploads {
        proxy_pass http://localhost:3000;
        proxy_cache_valid 200 1d;
        add_header Cache-Control "public, max-age=86400";
    }
    
    # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤
    client_max_body_size 50M;
}
EOF

echo "   ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞: $NGINX_CONFIG"
echo ""

# 4. –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–æ–π —Å—Å—ã–ª–∫–∏
echo "4Ô∏è‚É£ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
if [ -L "/etc/nginx/sites-enabled/$DOMAIN" ]; then
    echo "   ‚ö†Ô∏è  –°–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é..."
    sudo rm "/etc/nginx/sites-enabled/$DOMAIN"
fi

sudo ln -s "$NGINX_CONFIG" "/etc/nginx/sites-enabled/$DOMAIN"
echo "   ‚úÖ –°–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞"
echo ""

# 5. –£–¥–∞–ª–µ–Ω–∏–µ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
echo "5Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
if [ -L "/etc/nginx/sites-enabled/default" ]; then
    echo "   ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω–∞ –¥–µ—Ñ–æ–ª—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, —É–¥–∞–ª—è–µ–º..."
    sudo rm "/etc/nginx/sites-enabled/default"
    echo "   ‚úÖ –î–µ—Ñ–æ–ª—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞"
else
    echo "   ‚úÖ –î–µ—Ñ–æ–ª—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
fi
echo ""

# 6. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è ACME challenge
echo "6Ô∏è‚É£ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è ACME challenge..."
sudo mkdir -p /var/www/html/.well-known/acme-challenge
sudo chown -R www-data:www-data /var/www/html
sudo chmod -R 755 /var/www/html
echo "   ‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞"
echo ""

# 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
echo "7Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ Nginx..."
if sudo nginx -t 2>&1 | grep -q "successful"; then
    echo "   ‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
else
    echo "   ‚ùå –û—à–∏–±–∫–∏ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:"
    sudo nginx -t
    exit 1
fi
echo ""

# 8. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Nginx
echo "8Ô∏è‚É£ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Nginx..."
sudo systemctl restart nginx
echo "   ‚úÖ Nginx –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
echo ""

# 9. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo "9Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ Nginx..."
if systemctl is-active --quiet nginx; then
    echo "   ‚úÖ Nginx —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "   ‚ùå Nginx –Ω–µ –∑–∞–ø—É—â–µ–Ω"
    sudo systemctl status nginx
    exit 1
fi
echo ""

# 10. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
echo "üîü –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏..."
sleep 2

LOCAL_CHECK=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 2>/dev/null || echo "000")
DOMAIN_CHECK=$(curl -s -o /dev/null -w "%{http_code}" http://$DOMAIN 2>/dev/null || echo "000")

if [ "$LOCAL_CHECK" = "200" ] || [ "$LOCAL_CHECK" = "404" ]; then
    echo "   ‚úÖ localhost:3000 –¥–æ—Å—Ç—É–ø–µ–Ω (HTTP $LOCAL_CHECK)"
else
    echo "   ‚ö†Ô∏è  localhost:3000 –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (HTTP $LOCAL_CHECK)"
    echo "   üí° –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ: pm2 list"
fi

if [ "$DOMAIN_CHECK" = "200" ] || [ "$DOMAIN_CHECK" = "404" ]; then
    echo "   ‚úÖ –î–æ–º–µ–Ω $DOMAIN –¥–æ—Å—Ç—É–ø–µ–Ω (HTTP $DOMAIN_CHECK)"
elif [ "$DOMAIN_CHECK" = "000" ]; then
    echo "   ‚ö†Ô∏è  –î–æ–º–µ–Ω $DOMAIN –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    echo "   üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ DNS: nslookup $DOMAIN"
else
    echo "   ‚ö†Ô∏è  –î–æ–º–µ–Ω $DOMAIN –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTTP $DOMAIN_CHECK"
fi
echo ""

# –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo ""
echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ DNS –∑–∞–ø–∏—Å–∏:"
echo "   nslookup $DOMAIN"
echo "   –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å IP –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞"
echo ""
echo "2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É —Å–∞–π—Ç–∞:"
echo "   curl http://$DOMAIN"
echo ""
echo "3. –ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ DNS –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ SSL:"
echo "   sudo certbot --nginx -d $DOMAIN -d $WWW_DOMAIN"
echo ""
echo "üìù –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤: $NGINX_CONFIG"
echo ""

