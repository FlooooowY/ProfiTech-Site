# Настройка MySQL для каталога товаров

## Быстрый старт

### 1. Создание таблиц

```bash
npm run db:create
```

Это создаст все необходимые таблицы с оптимизированными индексами:
- `categories` - категории товаров
- `subcategories` - подкатегории товаров
- `products` - товары
- `product_characteristics` - характеристики товаров
- `filter_cache` - кэш для фильтров

### 2. Импорт категорий и подкатегорий

```bash
npm run db:import-categories
```

Импортирует все категории и подкатегории из `constants/categories.ts`.

### 3. Импорт товаров

Сначала убедитесь, что у вас есть файл `public/data/products.json` (создается через `/admin` импорт).

Затем выполните:

```bash
npm run db:import-products
```

Это импортирует все товары и их характеристики в MySQL.

## Оптимизации

### Индексы базы данных

Созданы следующие индексы для максимальной производительности:

**Таблица products:**
- `idx_category` - фильтрация по категории
- `idx_subcategory` - фильтрация по подкатегории
- `idx_manufacturer` - фильтрация по производителю
- `idx_category_subcategory` - композитный индекс для фильтрации по категории + подкатегории
- `idx_category_manufacturer` - композитный индекс для фильтрации по категории + производителю
- `idx_subcategory_manufacturer` - композитный индекс для фильтрации по подкатегории + производителю
- `idx_name_fulltext` - полнотекстовый поиск по названию
- `idx_description_fulltext` - полнотекстовый поиск по описанию

**Таблица product_characteristics:**
- `idx_product` - быстрая загрузка характеристик товара
- `idx_name` - фильтрация по названию характеристики
- `idx_value` - фильтрация по значению
- `idx_name_value` - композитный индекс для фильтрации
- `idx_product_name` - композитный индекс для загрузки характеристик товара

### Оптимизации API

1. **SQL-оптимизация:**
   - Использование `DISTINCT` для исключения дубликатов
   - Пагинация на уровне SQL (`LIMIT/OFFSET`)
   - Оптимизированные JOIN для характеристик
   - Параллельные запросы где возможно

2. **Кэширование:**
   - Кэш запросов на 5 минут для каталога
   - Кэш статистики на 2 минуты
   - HTTP кэширование с `Cache-Control` заголовками

3. **Батч-загрузка:**
   - Характеристики загружаются одним запросом для всех товаров
   - Использование `IN` для множественных значений

4. **Пул соединений:**
   - Увеличен лимит соединений до 20
   - Keep-alive для переиспользования соединений

## Производительность

Ожидаемая производительность:
- Загрузка каталога (24 товара): **< 100ms**
- Фильтрация по категории: **< 50ms**
- Фильтрация по характеристикам: **< 150ms**
- Поиск по тексту: **< 200ms**
- Загрузка статистики: **< 80ms**

## Переменные окружения

Создайте файл `.env.local`:

```env
DB_HOST=localhost
DB_USER=profitech_db
DB_PASSWORD=nDpDE4luD7G84uk3!@#
DB_NAME=profitech_db
```

## Обновление данных

При обновлении товаров через `/admin`:
1. Данные сохраняются в `public/data/products.json`
2. Запустите `npm run db:import-products` для синхронизации с MySQL

## Резервное копирование

Рекомендуется регулярно делать бэкап базы данных:

```bash
mysqldump -u profitech_db -p profitech_db > backup.sql
```

